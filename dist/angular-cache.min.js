/**
* @author Jason Dobry <jason.dobry@gmail.com>
* @file angular-cache.min.js
* @version 2.1.0 - Homepage <http://jmdobry.github.io/angular-cache/>
* @copyright (c) 2013 Jason Dobry <http://jmdobry.github.io/angular-cache>
* @license MIT <https://github.com/jmdobry/angular-cache/blob/master/LICENSE>
*
* @overview angular-cache is a very useful replacement for Angular's $cacheFactory.
*/
!function(a,b,c){"use strict";function d(){this.$get=function(){function a(a,b,c){for(var d=a[c],e=b(d);c>0;){var f=Math.floor((c+1)/2)-1,g=a[f];if(e>=b(g))break;a[f]=d,a[c]=g,c=f}}function c(a,b,c){for(var d=a.length,e=a[c],f=b(e);;){var g=2*(c+1),h=g-1,i=null;if(d>h){var j=a[h],k=b(j);f>k&&(i=h)}if(d>g){var l=a[g],m=b(l);m<(null===i?f:b(a[h]))&&(i=g)}if(null===i)break;a[c]=a[i],a[i]=e,c=i}}function d(a){if(a&&!b.isFunction(a))throw new Error("BinaryHeap(weightFunc): weightFunc: must be a function!");a=a||function(a){return a},this.weightFunc=a,this.heap=[]}return d.prototype.push=function(b){this.heap.push(b),a(this.heap,this.weightFunc,this.heap.length-1)},d.prototype.peek=function(){return this.heap[0]},d.prototype.pop=function(){var a=this.heap[0],b=this.heap.pop();return this.heap.length>0&&(this.heap[0]=b,c(this.heap,this.weightFunc,0)),a},d.prototype.remove=function(d){for(var e=this.heap.length,f=0;e>f;f++)if(b.equals(this.heap[f],d)){var g=this.heap[f],h=this.heap.pop();return f!==e-1&&(this.heap[f]=h,a(this.heap,this.weightFunc,f),c(this.heap,this.weightFunc,f)),g}return null},d.prototype.removeAll=function(){this.heap=[]},d.prototype.size=function(){return this.heap.length},d}}function e(){function a(a,c){b.isNumber(a)?0>a?c("must be greater than zero!"):c(null):c("must be a number!")}var d,e=function(){return{capacity:Number.MAX_VALUE,maxAge:null,deleteOnExpire:"none",onExpire:null,cacheFlushInterval:null,recycleFreq:1e3,storageMode:"none",storageImpl:null,verifyIntegrity:!0}};this.setCacheDefaults=function(c){var f="$angularCacheFactoryProvider.setCacheDefaults(options): ";if(c=c||{},!b.isObject(c))throw new Error(f+"options: must be an object!");if("capacity"in c&&a(c.capacity,function(a){if(a)throw new Error(f+"capacity: "+a)}),"deleteOnExpire"in c){if(!b.isString(c.deleteOnExpire))throw new Error(f+"deleteOnExpire: must be a string!");if("none"!==c.deleteOnExpire&&"passive"!==c.deleteOnExpire&&"aggressive"!==c.deleteOnExpire)throw new Error(f+'deleteOnExpire: accepted values are "none", "passive" or "aggressive"!')}if("maxAge"in c&&a(c.maxAge,function(a){if(a)throw new Error(f+"maxAge: "+a)}),"recycleFreq"in c&&a(c.recycleFreq,function(a){if(a)throw new Error(f+"recycleFreq: "+a)}),"cacheFlushInterval"in c&&a(c.cacheFlushInterval,function(a){if(a)throw new Error(f+"cacheFlushInterval: "+a)}),"storageMode"in c){if(!b.isString(c.storageMode))throw new Error(f+"storageMode: must be a string!");if("none"!==c.storageMode&&"localStorage"!==c.storageMode&&"sessionStorage"!==c.storageMode)throw new Error(f+'storageMode: accepted values are "none", "localStorage" or "sessionStorage"!');if("storageImpl"in c){if(!b.isObject(c.storageImpl))throw new Error(f+"storageImpl: must be an object!");if(!("setItem"in c.storageImpl&&"function"==typeof c.storageImpl.setItem))throw new Error(f+'storageImpl: must implement "setItem(key, value)"!');if(!("getItem"in c.storageImpl&&"function"==typeof c.storageImpl.getItem))throw new Error(f+'storageImpl: must implement "getItem(key)"!');if(!("removeItem"in c.storageImpl)||"function"!=typeof c.storageImpl.removeItem)throw new Error(f+'storageImpl: must implement "removeItem(key)"!')}}if("onExpire"in c&&"function"!=typeof c.onExpire)throw new Error(f+"onExpire: must be a function!");d=b.extend({},e(),c)},this.setCacheDefaults({}),this.$get=["$window","BinaryHeap",function(e,f){function g(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=b);return c}function h(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(b);return c}function i(i,j){function l(b){a(b,function(a){if(a)throw new Error("capacity: "+a);for(y.capacity=b;B.size()>y.capacity;)E.remove(B.peek().key,{verifyIntegrity:!1})})}function m(a){if(!b.isString(a))throw new Error("deleteOnExpire: must be a string!");if("none"!==a&&"passive"!==a&&"aggressive"!==a)throw new Error('deleteOnExpire: accepted values are "none", "passive" or "aggressive"!');y.deleteOnExpire=a}function n(b){var c=h(z);if(null===b){if(y.maxAge)for(var d=0;d<c.length;d++){var e=c[d];"maxAge"in z[e]||(delete z[e].expires,A.remove(z[e]))}y.maxAge=b}else a(b,function(a){if(a)throw new Error("maxAge: "+a);if(b!==y.maxAge){y.maxAge=b;for(var d=(new Date).getTime(),e=0;e<c.length;e++){var f=c[e];"maxAge"in z[f]||(A.remove(z[f]),z[f].expires=z[f].created+y.maxAge,A.push(z[f]),z[f].expires<d&&E.remove(f,{verifyIntegrity:!1}))}}})}function o(b){null===b?(y.recycleFreqId&&(clearInterval(y.recycleFreqId),delete y.recycleFreqId),y.recycleFreq=d.recycleFreq,y.recycleFreqId=setInterval(E.removeExpired,y.recycleFreq)):a(b,function(a){if(a)throw new Error("recycleFreq: "+a);y.recycleFreq=b,y.recycleFreqId&&clearInterval(y.recycleFreqId),y.recycleFreqId=setInterval(E.removeExpired,y.recycleFreq)})}function p(b){null===b?(y.cacheFlushIntervalId&&(clearInterval(y.cacheFlushIntervalId),delete y.cacheFlushIntervalId),y.cacheFlushInterval=b):a(b,function(a){if(a)throw new Error("cacheFlushInterval: "+a);b!==y.cacheFlushInterval&&(y.cacheFlushIntervalId&&clearInterval(y.cacheFlushIntervalId),y.cacheFlushInterval=b,y.cacheFlushIntervalId=setInterval(E.removeAll,y.cacheFlushInterval))})}function q(a,c){var d,f;if(!b.isString(a))throw new Error("storageMode: must be a string!");if("none"!==a&&"localStorage"!==a&&"sessionStorage"!==a)throw new Error('storageMode: accepted values are "none", "localStorage" or "sessionStorage"!');if(("localStorage"===y.storageMode||"sessionStorage"===y.storageMode)&&a!==y.storageMode){for(d=h(z),f=0;f<d.length;f++)F.removeItem(C+".data."+d[f]);F.removeItem(C+".keys")}if(y.storageMode=a,c){if(!b.isObject(c))throw new Error("storageImpl: must be an object!");if(!("setItem"in c&&"function"==typeof c.setItem))throw new Error('storageImpl: must implement "setItem(key, value)"!');if(!("getItem"in c&&"function"==typeof c.getItem))throw new Error('storageImpl: must implement "getItem(key)"!');if(!("removeItem"in c)||"function"!=typeof c.removeItem)throw new Error('storageImpl: must implement "removeItem(key)"!');F=c}else"localStorage"===y.storageMode?F=e.localStorage:"sessionStorage"===y.storageMode&&(F=e.sessionStorage);if("none"!==y.storageMode&&F)if(D)for(d=h(z),f=0;f<d.length;f++)t(d[f]);else s()}function r(a,c,e){if(a=a||{},e=e||{},c=!!c,!b.isObject(a))throw new Error("AngularCache.setOptions(cacheOptions, strict, options): cacheOptions: must be an object!");if(u(e.verifyIntegrity),c&&(a=b.extend({},d,a)),"verifyIntegrity"in a&&(y.verifyIntegrity=a.verifyIntegrity===!0),"capacity"in a&&l(a.capacity),"deleteOnExpire"in a&&m(a.deleteOnExpire),"maxAge"in a&&n(a.maxAge),"recycleFreq"in a&&o(a.recycleFreq),"cacheFlushInterval"in a&&p(a.cacheFlushInterval),"storageMode"in a&&q(a.storageMode,a.storageImpl),"onExpire"in a){if(null!==a.onExpire&&"function"!=typeof a.onExpire)throw new Error("onExpire: must be a function!");y.onExpire=a.onExpire}D=!0}function s(){var a=b.fromJson(F.getItem(C+".keys"));if(F.removeItem(C+".keys"),a&&a.length){for(var c=0;c<a.length;c++){var d=b.fromJson(F.getItem(C+".data."+a[c])),e=d.maxAge||y.maxAge,f=d.deleteOnExpire||y.deleteOnExpire;if(e&&(new Date).getTime()-d.created>e&&"aggressive"===f)F.removeItem(C+".data."+a[c]);else{var g={created:d.created};d.expires&&(g.expires=d.expires),d.accessed&&(g.accessed=d.accessed),d.maxAge&&(g.maxAge=d.maxAge),d.deleteOnExpire&&(g.deleteOnExpire=d.deleteOnExpire),E.put(a[c],d.value,g)}}t(null)}}function t(a){"none"!==y.storageMode&&F&&(F.setItem(C+".keys",b.toJson(h(z))),a&&F.setItem(C+".data."+a,b.toJson(z[a])))}function u(a){if((a||a!==!1&&y.verifyIntegrity)&&"none"!==y.storageMode&&F){var c=h(z);F.setItem(C+".keys",b.toJson(c));for(var d=0;d<c.length;d++)F.setItem(C+".data."+c[d],b.toJson(z[c[d]]))}}function v(a){if("none"!==y.storageMode&&F){var c=a||h(z);F.setItem(C+".keys",b.toJson(c))}}function w(a){"none"!==y.storageMode&&F&&F.setItem(C+".data."+a,b.toJson(z[a]))}function x(){if("none"!==y.storageMode&&F){for(var a=h(z),c=0;c<a.length;c++)F.removeItem(C+".data."+a[c]);F.setItem(C+".keys",b.toJson([]))}}var y=b.extend({},{id:i}),z={},A=new f(function(a){return a.expires}),B=new f(function(a){return a.accessed}),C="angular-cache.caches."+i,D=!1,E=this,F=null;j=j||{},this.put=function(c,d,e){if(e=e||{},!b.isString(c))throw new Error("AngularCache.put(key, value, options): key: must be a string!");if(e&&!b.isObject(e))throw new Error("AngularCache.put(key, value, options): options: must be an object!");if(e.maxAge&&null!==e.maxAge)a(e.maxAge,function(a){if(a)throw new Error("AngularCache.put(key, value, options): maxAge: "+a)});else{if(e.deleteOnExpire&&!b.isString(e.deleteOnExpire))throw new Error("AngularCache.put(key, value, options): deleteOnExpire: must be a string!");if(e.deleteOnExpire&&"none"!==e.deleteOnExpire&&"passive"!==f&&"aggressive"!==f)throw new Error('AngularCache.put(key, value, options): deleteOnExpire: accepted values are "none", "passive" or "aggressive"!');if(b.isUndefined(d))return}var f,g,h=(new Date).getTime();return u(e.verifyIntegrity),z[c]?(A.remove(z[c]),B.remove(z[c])):z[c]={key:c},g=z[c],g.value=d,g.created=parseInt(e.created,10)||g.created||h,g.accessed=parseInt(e.accessed,10)||h,e.deleteOnExpire&&(g.deleteOnExpire=e.deleteOnExpire),e.maxAge&&(g.maxAge=e.maxAge),(g.maxAge||y.maxAge)&&(g.expires=g.created+(g.maxAge||y.maxAge)),f=g.deleteOnExpire||y.deleteOnExpire,g.expires&&"aggressive"===f&&A.push(g),v(),w(c),B.push(g),B.size()>y.capacity&&this.remove(B.peek().key,{verifyIntegrity:!1}),d},this.get=function(a,d){if(b.isArray(a)){var e=a,f=[];return b.forEach(e,function(a){var c=E.get(a,d);b.isDefined(c)&&f.push(c)}),f}if(d=d||{},!b.isString(a))throw new Error("AngularCache.get(key, options): key: must be a string!");if(d&&!b.isObject(d))throw new Error("AngularCache.get(key, options): options: must be an object!");if(d.onExpire&&!b.isFunction(d.onExpire))throw new Error("AngularCache.get(key, options): onExpire: must be a function!");if(a in z){u(d.verifyIntegrity);var g=z[a],h=g.value,i=(new Date).getTime(),j=g.deleteOnExpire||y.deleteOnExpire;return B.remove(g),g.accessed=i,B.push(g),"passive"===j&&"expires"in g&&g.expires<i&&(this.remove(a,{verifyIntegrity:!1}),y.onExpire?y.onExpire(a,g.value,d.onExpire):d.onExpire&&d.onExpire(a,g.value),h=c),w(a),h}},this.remove=function(a,b){b=b||{},u(b.verifyIntegrity),B.remove(z[a]),A.remove(z[a]),"none"!==y.storageMode&&F&&F.removeItem(C+".data."+a),delete z[a],v()},this.removeAll=function(){x(),B.removeAll(),A.removeAll(),z={}},this.removeExpired=function(a){a=a||{},u(a.verifyIntegrity);for(var b=(new Date).getTime(),c=A.peek();c&&c.expires&&c.expires<b;)E.remove(c.key,{verifyIntegrity:!1}),y.onExpire&&y.onExpire(c.key,c.value),c=A.peek()},this.destroy=function(){y.cacheFlushIntervalId&&clearInterval(y.cacheFlushIntervalId),y.recycleFreqId&&clearInterval(y.recycleFreqId),this.removeAll(),"none"!==y.storageMode&&F&&(F.removeItem(C+".keys"),F.removeItem(C)),F=null,z=null,B=null,A=null,y=null,C=null,E=null;for(var a=h(this),b=0;b<a.length;b++)this.hasOwnProperty(a[b])&&delete this[a[b]];k[i]=null,delete k[i]},this.info=function(a){if(a){if(z[a]){var c={created:z[a].created,accessed:z[a].accessed,expires:z[a].expires,maxAge:z[a].maxAge||y.maxAge,deleteOnExpire:z[a].deleteOnExpire||y.deleteOnExpire,isExpired:!1};return c.maxAge&&(c.isExpired=(new Date).getTime()-c.created>c.maxAge),c}return z[a]}return b.extend({},y,{size:B&&B.size()||0})},this.keySet=function(){return g(z)},this.keys=function(){return h(z)},this.setOptions=r,r(j,!0,{verifyIntegrity:!1})}function j(a,c){if(a in k)throw new Error("cacheId "+a+" taken!");if(!b.isString(a))throw new Error("cacheId must be a string!");return k[a]=new i(a,c),k[a]}var k={};return j.info=function(){for(var a=h(k),c={size:a.length,caches:{}},e=0;e<a.length;e++){var f=a[e];c.caches[f]=k[f].info()}return c.cacheDefaults=b.extend({},d),c},j.get=function(a){if(!b.isString(a))throw new Error("$angularCacheFactory.get(cacheId): cacheId: must be a string!");return k[a]},j.keySet=function(){return g(k)},j.keys=function(){return h(k)},j.removeAll=function(){for(var a=h(k),b=0;b<a.length;b++)k[a[b]].destroy()},j.clearAll=function(){for(var a=h(k),b=0;b<a.length;b++)k[a[b]].removeAll()},j}]}b.module("jmdobry.binary-heap",[]),b.module("jmdobry.binary-heap").provider("BinaryHeap",d),b.module("jmdobry.angular-cache",["ng","jmdobry.binary-heap"]),b.module("jmdobry.angular-cache").provider("$angularCacheFactory",e)}(window,window.angular);